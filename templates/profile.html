{% include "header.html" %}

<div class="container-fluid py-4">

  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="fw-bold mb-1">
        <i class="fas fa-user-astronaut text-primary me-2"></i>
        Developer Profile
      </h3>
      <p class="text-muted mb-0">
        Performance & learning insights based on your GitHub activity
      </p>
    </div>

   
  </div>

  <!-- PROFILE SUMMARY -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
      <h5 class="fw-bold text-primary mb-2">
        <i class="fas fa-award me-2"></i> Performance Summary
      </h5>

      <p id="profileSummary" class="text-muted mb-4">
        Analyzing your learning journey and improvement trend...
      </p>

      <div class="row">
        <div class="col-md-4">
          <div class="p-3 bg-light rounded text-center">
            <h6 class="text-muted">Overall Growth</h6>
            <h4 class="fw-bold text-success" id="growthLevel">Loading...</h4>
          </div>
        </div>

        <div class="col-md-4">
          <div class="p-3 bg-light rounded text-center">
            <h6 class="text-muted">Total Public Repositories</h6>
            <h4 class="fw-bold text-primary">{{ analyses|length }}</h4>
          </div>
        </div>

        <div class="col-md-4">
          <div class="p-3 bg-light rounded text-center">
            <h6 class="text-muted">Primary Languages</h6>
            <h4 class="fw-bold text-info" id="languagesUsed">Loading...</h4>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PROJECTS -->
  <h5 class="fw-bold mb-3">
    <i class="fas fa-project-diagram me-2 text-info"></i>
    Analyzed Projects
  </h5>

  <div class="row g-4">
    {% for a in analyses %}
    {% if a.documentation_score is not none %}
    {% set repo_name = a.repo_url.split('/')[-1].replace('.git','') %}

    <div class="col-md-6 col-lg-4">
      <div class="card h-100 shadow-sm border-hover">
        <div class="card-header bg-light d-flex justify-content-between">
          <strong>{{ repo_name }}</strong>
          <span class="badge bg-success">Analyzed</span>
        </div>

        <div class="card-body">
          <p class="mb-2">
            <strong>Language:</strong> {{ a.language or "Unknown" }}
          </p>

          <ul class="list-unstyled small mb-3">
            <li>ðŸ“„ Documentation: {{ a.documentation_score }}%</li>
            <li>ðŸ’» Code Quality: {{ a.code_quality_score }}%</li>
            <li>ðŸ›  Maintainability: {{ a.maintainability_score }}%</li>
          </ul>

          <button class="btn btn-outline-primary btn-sm w-100"
                  onclick="openProgress({{ a.id }})">
            <i class="fas fa-chart-line me-1"></i>
            View Learning Graph
          </button>
        </div>
      </div>
    </div>

    {% endif %}
    {% endfor %}
  </div>

</div>

<!-- PROGRESS MODAL -->
<div class="modal fade" id="progressModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="fas fa-chart-line me-2"></i> Learning Progress
        </h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <canvas id="progressChart" height="300"></canvas>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ================= SHARE PROFILE (DOWNLOAD TXT) ================= */
function shareProfile() {
  fetch('/profile/share')
    .then(r => r.json())
    .then(data => {
      if (data.error) {
        alert(data.error);
        return;
      }
      const blob = new Blob([data.content], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = data.filename;
      link.click();
    });
}

/* ================= LOAD FAST PROFILE SUMMARY ================= */
fetch('/profile/summary')
  .then(r => r.json())
  .then(d => {
    document.getElementById('growthLevel').textContent = d.growth;
    document.getElementById('languagesUsed').textContent =
      d.languages.length ? d.languages.join(', ') : 'N/A';

    document.getElementById('profileSummary').textContent =
      'Your repositories show consistent improvement in code quality, structure, and maintainability.';
  });

/* ================= LEARNING GRAPH ================= */
let chart;
function openProgress(repoId) {
  fetch(`/github/progress/${repoId}`)
    .then(r => r.json())
    .then(d => {
      if (chart) chart.destroy();

      const ctx = document.getElementById('progressChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: d.labels,
          datasets: [
            {
              label: 'Documentation',
              data: d.documentation,
              borderColor: '#0dcaf0'
            },
            {
              label: 'Code Quality',
              data: d.code_quality,
              borderColor: '#198754'
            },
            {
              label: 'Maintainability',
              data: d.maintainability,
              borderColor: '#ffc107'
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, max: 100 }
          }
        }
      });

      new bootstrap.Modal(
        document.getElementById('progressModal')
      ).show();
    });
}
</script>

<style>
.border-hover {
  transition: all 0.2s ease;
}
.border-hover:hover {
  transform: translateY(-3px);
  box-shadow: 0 0.75rem 1.5rem rgba(0,0,0,.15);
}
</style>

{% include "footer.html" %}
